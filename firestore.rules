rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction helper pour vérifier si l'utilisateur est admin
    // Utilise les Custom Claims définis par la Cloud Function 'setAdminRole'
    function isAdmin() {
      // Check for 'admin' custom claim OR fallback to email check for existing sessions
      return request.auth != null && (
        (request.auth.token.keys().hasAny(['admin']) && request.auth.token.admin == true) || 
        request.auth.token.email == 'benevole@scba.fr'
      );
    }

    // Fonction pour vérifier si l'utilisateur est connecté
    function isAuth() {
      return request.auth != null;
    }

    // Annonces : Lecture publique, Écriture Admin seulement
    // EXCEPTION: Suppression autorisée pour annonces expirées (cleanup automatique)
    match /announcements/{announcement} {
      allow read: if true;
      allow create, update: if isAdmin();
      allow delete: if isAdmin() || 
                      (resource.data.expiresAt != null && resource.data.expiresAt < request.time);
    }

    // Matchs : 
    // - Lecture publique (tout le monde doit voir les matchs)
    // - Création/Suppression : Admin seulement
    // - Mise à jour : Admin ou Utilisateur connecté (pour s'inscrire/désinscrire)
    match /matches/{matchId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      // Allow update ONLY if authenticated AND only modifying the 'roles' field (for volunteer signup)
      // OR if the user is an admin (who can edit everything)
      allow update: if isAdmin() || (isAuth() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['roles'])); 
    }

    // Données Utilisateurs (Inscriptions, Profil...)
    // - Accès strict au propriétaire du compte OU Admin
    match /users/{userId}/{document=**} {
      allow read, write: if isAuth() && (request.auth.uid == userId || isAdmin());
    }
  }
}
